#include <unistd.h>  // Для работы с системными вызовами, такими как dup, dup2, close
#include <fcntl.h>   // Для работы с файловыми дескрипторами и флагами открытия файлов
#include <stdio.h>  // Для работы с функциями ввода-вывода, такими как printf
#include <stdlib.h> // Для работы с функцией exit

int main() {
    // Создание переменных для файлового дескриптора и для хранения копии дескриптора stdout
    int fd, saved_stdout;

    // Открываем файл "output.txt" для записи. Если файл не существует, он будет создан.
    // O_WRONLY - открыть для записи, O_CREAT - создать файл, если его нет,
    // O_TRUNC - очистить содержимое файла, если он существует.
    // 0644 - права доступа к файлу (rw-r--r--)
    fd = open("output.txt", O_WRONLY | O_CREAT | O_TRUNC, 0644);
    if (fd == -1) {
        perror("open"); // Выводим сообщение об ошибке, если файл не удалось открыть
        exit(1);        // Завершаем программу с кодом ошибки
    }

    // Сохраняем текущий дескриптор stdout в переменную saved_stdout
    saved_stdout = dup(STDOUT_FILENO);

    // Перенаправляем stdout на файловый дескриптор fd
    if (dup2(fd, STDOUT_FILENO) == -1) {
        perror("dup2"); // Выводим сообщение об ошибке, если перенаправление не удалось
        close(fd);      // Закрываем файловый дескриптор
        exit(1);        // Завершаем программу с кодом ошибки
    }

    // Выводим строку в файл, так как stdout теперь перенаправлен на файл
    printf("Hello, file\n");

    // Сбрасываем буфер stdout на диск, чтобы убедиться, что данные записаны в файл
    fflush(stdout);

    // Возвращаем вывод на экран, восстанавливая оригинальный stdout
    dup2(saved_stdout, STDOUT_FILENO);

    // Закрываем файловый дескриптор и сохраненный дескриптор stdout
    close(fd);
    close(saved_stdout);

    return 0; // Завершаем программу успешно
}